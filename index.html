<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>My Cashbook</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
    <link rel="stylesheet" href="app.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Personal Cashbook</h1>
        <div class="year-controls">
          <label for="year-select">Year:</label>
          <select id="year-select"></select>
          <button id="new-year" class="btn-indigo">Add Year</button>
        </div>
        <button id="open-category-drawer" class="btn-indigo" style="margin-left: 12px">Categories</button>
        <!-- In your header, replace the login button with this -->
        <button id="loginBtn" class="btn-indigo">Sign in with Google</button>
        <div id="user-info" style="display: none; align-items: center; gap: 12px">
          <img id="user-pic" style="width: 32px; height: 32px; border-radius: 50%" referrerpolicy="no-referrer" />
          <span id="user-name"></span>
          <button id="logoutBtn" class="btn-gray" style="margin-left: 8px">Sign Out</button>
        </div>
      </header>

      <div id="transaction-buttons" style="display: flex; gap: 16px; margin-bottom: 32px">
        <button
          id="open-income-drawer"
          style="background: #01865f; color: #fff; font-weight: 700; border-radius: 8px; padding: 12px 32px; font-size: 1.1rem"
        >
          Add Income
        </button>
        <button
          id="open-expense-drawer"
          style="background: #c93b3b; color: #fff; font-weight: 700; border-radius: 8px; padding: 12px 32px; font-size: 1.1rem"
        >
          Add Expense
        </button>
      </div>

      <!-- Summary Cards -->
      <div id="summary-cards">
        <div class="summary-card summary-balance">
          <span>Balance</span>
          <span id="balance" class="summary-value">৳0.00</span>
        </div>
        <div class="summary-card summary-income">
          <span>Total Income</span>
          <span id="total-income" class="summary-value">৳0.00</span>
        </div>
        <div class="summary-card summary-expense">
          <span>Total Expense</span>
          <span id="total-expense" class="summary-value">৳0.00</span>
        </div>
      </div>

      <!-- Filters Section -->
      <section class="filters-section">
        <h2 style="font-size: 1.5rem; font-weight: 700; color: #4338ca; margin-bottom: 16px">Filters</h2>
        <div class="filters-row">
          <div>
            <label for="month-filter" style="display: block; margin-bottom: 8px">Month:</label>
            <select id="month-filter"></select>
          </div>
          <div>
            <label for="category-filter" style="display: block; margin-bottom: 8px">Category:</label>
            <select id="category-filter">
              <option value="">All</option>
            </select>
          </div>
          <button id="clear-filters" class="btn-gray" style="align-self: flex-end">Clear Filters</button>
        </div>
      </section>

      <!-- Transactions Section -->
      <section class="transactions-section">
        <div class="table-container">
          <div id="pdf-export-area">
            <div class="transactions-header">
              <h2 style="font-size: 1.5rem; font-weight: 700; color: #4338ca">Transactions</h2>
              <span id="filter-summary"></span>
              <div class="transactions-actions">
                <button id="delete-all" class="btn-red">Delete All</button>
                <button id="export-pdf" class="btn-indigo">Export PDF</button>
              </div>
            </div>

            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Description</th>
                  <th>Amount</th>
                  <th>Type</th>
                  <th>Category</th>
                  <th>Month</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="transactions-tbody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>

    <!-- Drawer Sidebar -->
    <div id="drawer-overlay" class="drawer-overlay" style="display: none"></div>
    <aside id="drawer-sidebar" class="drawer-sidebar" style="display: none">
      <button id="drawer-close" class="drawer-close-btn" title="Close">&times;</button>
      <div id="drawer-content"></div>
    </aside>
    <!-- Drawer Sidebar -->

    <!-- Modal Dialog -->
    <div
      id="modal-overlay"
      style="
        display: none;
        position: fixed;
        z-index: 99999;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.25);
        align-items: center;
        justify-content: center;
      "
    >
      <div
        id="modal-dialog"
        style="background: #fff; padding: 32px 24px; border-radius: 16px; box-shadow: 0 4px 32px #0002; min-width: 320px; max-width: 90vw"
      >
        <div id="modal-content"></div>
        <div id="modal-actions" style="margin-top: 24px; display: flex; gap: 16px; justify-content: flex-end"></div>
      </div>
    </div>
    <!-- Modal Dialog -->

    <!-- Firebase App -->
    <script type="module">
      // Firebase v12 modular imports
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
      import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
      import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

      // Firebase config (your actual keys)
      const firebaseConfig = {
        apiKey: "AIzaSyAEq4Ag_G1ellScwE1qssK4moo7cW5C6Vk",
        authDomain: "dailyexpense-4e3c1.firebaseapp.com",
        projectId: "dailyexpense-4e3c1",
        storageBucket: "dailyexpense-4e3c1.firebasestorage.app",
        messagingSenderId: "682477656643",
        appId: "1:682477656643:web:db9e3655263cf4f67b52f6",
        measurementId: "G-FNLM0742XB",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      const provider = new GoogleAuthProvider();

      document.getElementById("loginBtn").addEventListener("click", async () => {
        try {
          const result = await signInWithPopup(auth, provider);
          const user = result.user;

          console.log("User Info:", user);

          // Save user to Firestore
          await setDoc(
            doc(db, "users", user.uid),
            {
              name: user.displayName,
              email: user.email,
              photo: user.photoURL,
              lastLogin: new Date(),
            },
            { merge: true }
          );

          console.log("User data saved to Firestore");
        } catch (error) {
          console.error("Error during sign-in:", error);
        }
      });

      import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

      // Show user info or login button based on auth state
      onAuthStateChanged(auth, (user) => {
        const loginBtn = document.getElementById("loginBtn");
        const userInfo = document.getElementById("user-info");
        if (user) {
          loginBtn.style.display = "none";
          userInfo.style.display = "flex";
          document.getElementById("user-pic").src = user.photoURL;
          document.getElementById("user-name").textContent = user.displayName;
          // Load user data from Firestore here (see next step)
        } else {
          loginBtn.style.display = "block";
          userInfo.style.display = "none";
        }
      });

      // Logout
      document.getElementById("logoutBtn").addEventListener("click", async () => {
        await signOut(auth);
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script type="module" src="app.js"></script>
  </body>
</html>
